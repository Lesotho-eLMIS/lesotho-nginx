{{ $loaded_services := services }}

{{ range $loaded_services }}
  {{ if in .Tags (env "SERVICE_TAG") }}
  upstream {{ .Name }} {
    least_conn;
    {{ range service .Name }}server {{ .Address }}:{{ .Port }};
    {{ end }}
  }
  {{ end }}
{{ end }}

log_format vhost '$host $remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent"';

access_log {{ env "NGINX_LOG_DIR" }}/access.log;
error_log {{ env "NGINX_LOG_DIR" }}/error.log;

server {
  listen 80;
  server_name {{ env "VIRTUAL_HOST" }};
  
  {{ range tree (env "RESOURCES_PATH") }}
    {{ $upstream := .Value }}
    {{ $location := .Key }}
    {{ $location := ($location | regexReplaceAll "{[\\w-]+}" "[\\w-]+") }}
    {{ $location := ($location | regexReplaceAll "<[\\w-]+>" ".+") }}
    location ~ /{{ $location }}/?$  {
      proxy_pass http://{{ $upstream }};
    }
  {{ end }}
}

