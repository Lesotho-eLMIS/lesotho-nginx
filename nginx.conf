{{ $loaded_services := services }}

{{ range $loaded_services }}
  {{ if in .Tags (env "SERVICE_TAG") }}
  upstream {{ .Name }} {
    least_conn;
    {{ range service .Name }}server {{ .Address }}:{{ .Port }};
    {{ end }}
  }
  {{ end }}
{{ end }}

log_format vhost '$host $remote_addr - $remote_user [$time_local] '
                 '"$request" $status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent"';

access_log {{ env "NGINX_LOG_DIR" }}/access.log;
error_log {{ env "NGINX_LOG_DIR" }}/error.log;

server {
  listen 80;
  server_name {{ env "VIRTUAL_HOST" }};
  
  {{ $host := env "RESOURCES_PATH" }}
  {{ $kv := tree $host }}
  {{ $idRegex := "{[\\w-]+}" }}
  {{ $idReplace := "[\\w-]+" }}
  {{ $allRegex := "<[\\w-]+>" }}
  {{ $allReplace := ".+" }}
  {{ $globalAllRegex := "^<[\\w-]+>$" }}
  
  # First retrieve paths without parameters
  {{ range $kv }}
    {{- $location := .Key }} {{ $upstream := .Value -}}
    {{ if not (or (regexMatch $idRegex $location) (regexMatch $allRegex $location)) }}
      location ~ /{{ $location }}/?$  {
        proxy_pass http://{{ $upstream }};
      }
    {{ end }}
  {{- end -}}
  
  # Retrieve paths with {param} wildcard
  {{ range $kv }}
    {{- $location := .Key -}} {{- $upstream := .Value -}}
    {{ if regexMatch $idRegex $location }}
      {{- $location := ($location | regexReplaceAll $idRegex $idReplace) -}}
      location ~ /{{ $location }}/?$  {
        proxy_pass http://{{ $upstream }};
      }
    {{ end }}
  {{- end -}}
  
  # Retrieve paths with <all> wildcard, but without global wildcard
  {{ range $kv }}
    {{- $location := .Key -}} {{- $upstream := .Value -}}
    {{ if and (regexMatch $allRegex $location) (not (regexMatch $globalAllRegex $location)) }}
      {{- $location := ($location | regexReplaceAll $allRegex $allReplace) -}}
      location ~ /{{ $location }}/?$  {
        proxy_pass http://{{ $upstream }};
      }
    {{ end }}
  {{- end -}}
  
  # Retrieve global <all> wildcard (if existent)
  {{ range $kv }}
    {{- $location := .Key -}} {{- $upstream := .Value -}}
    {{ if regexMatch $globalAllRegex $location }}
      location ~ /  {
        proxy_pass http://{{ $upstream }};
      }
      
      location ~ /.+$  {
        proxy_pass http://{{ $upstream }};
      }
    {{ end }}
  {{- end -}}
}

